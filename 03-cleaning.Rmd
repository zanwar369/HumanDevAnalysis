# Data transformation

In order to work with the amount of data we split the work into three separate buckets-- Human Security, education, and inequality.
We all performed similar transformations detailed below.


## INEQUALITY DATA TRANSFORMATION

The `Inequality` indicator has 15 features from years 2010 to 2018 (one column per year). However, the data table for 6 of these features were not available for download. The remaining 9 features for which data tables were available and was extracted were:

* Coefficient of Human Inequality

* Inequality-adjusted education index

* Inequality-adjusted HDI (IHDI)

* Inequality-adjusted income index

* Inequality-adjusted life expectancy index

* Inequality in education (%)^

* Inequality in income (%)^

* Inequality in life expectancy (%)

* Overall loss in HDI due to inequality (%)

^ Data for `2018` is either from 2018 or the latest year available. 

Note that the column 'HDI Rank (2018)' is kept as a reference column and not for analysis. 

First read all files:

```{r}
library(dplyr)
library(tidyverse)
library(readxl)
library(readr)
library(stringr)
```

```{r warning = FALSE,  message = FALSE, echo =TRUE}
temp <- list.files(path = "./Inequality/inequality_rawdata", pattern="*.csv")
 
inequality_list <- list()
for(i in 1:length(temp)){
  inequality_list[[i]] <- read_csv(paste0("./Inequality/inequality_rawdata/", temp[i]), skip = 1) %>%
                    select("HDI Rank (2018)", Country, `2010`, `2011`, `2012`, `2013`, 
                           `2014`, `2015`, `2016`, `2017`, `2018`) 
}
names(inequality_list) <- sub("\\..*", "", temp)
```

Now to take a high level look at the data itself, print the head and tail of the sixth data frame in the list `inequality_list`, which contains data for the "Inequality in education (%)" as a sample:

```{r}
print(head(inequality_list[[6]]))
print(tail(inequality_list[[6]]))
```

Inspection of the remaining data frame indicate that the last rows for every data frame in `inequality_list` are `NA`. In addition, some data frames have foot notes at the end of the table that was read in as a value in the first column. These rows are removed. 

```{r}
inequality_list[[1]] <- inequality_list[[1]] %>% 
                            filter(row_number() <= n()-1)
inequality_list[[2]] <- inequality_list[[2]] %>% 
                            filter(row_number() <= n()-1)
inequality_list[[3]] <- inequality_list[[3]] %>% 
                            filter(row_number() <= n()-1)
inequality_list[[4]] <- inequality_list[[4]] %>% 
                            filter(row_number() <= n()-1)
inequality_list[[5]] <- inequality_list[[5]] %>% 
                            filter(row_number() <= n()-1)
inequality_list[[6]] <- inequality_list[[6]] %>% 
                            filter(row_number() <= n()-3)
inequality_list[[7]] <- inequality_list[[7]] %>% 
                            filter(row_number() <= n()-3)
inequality_list[[8]] <- inequality_list[[8]] %>% 
                            filter(row_number() <= n()-2)
inequality_list[[9]] <- inequality_list[[9]] %>% 
                            filter(row_number() <= n()-1)
```

The below shows that the number of rows in the data frame for each feature is different. This implies not every feature has the same list of countries. 


```{r warning = FALSE,  message = FALSE}
for(i in 1:length(inequality_list)){
  row <- dim(inequality_list[[i]])[1]
  column <- dim(inequality_list[[i]])[2]
  print(paste0(sub("\\..*", "", temp[i])," feature has ", row, " rows and ", column, " columns."))
}
```
To investigate this further:

```{r, message = FALSE, warning = FALSE}
differences <- c()
for(i in 1:length(inequality_list)){
  for(j in 1:length(inequality_list)){
    differences <- c(differences,setdiff(inequality_list[[i]]$Country, inequality_list[[j]]$Country))
  }
}
print(unique(differences))
```
It looks like these four countries shows up for some features and not others. We can expect a lot of missing data for at least these four countries. 

The next step is to create a single tidy data frames for `Inequality`. Each data frame in `inequality_list` has column headings 2010 to 2018 which are values not variables. In addition, each data frame in `inequality_list` is from the same observational unit (`Inequality`) and should be in one data frame. To convert the list of data frames `inequality_list` into a single tidy data frame, use `pivot_longer` and `full_join` to create the tidy data frame `inequality_df`.   

```{r, echo=FALSE}
inequality_df <- inequality_list[[1]] %>% 
                    pivot_longer(!c('HDI Rank (2018)', 'Country'), 
                                 names_to = "Year", 
                                 values_to = names(inequality_list[1]))
for(i in 2:length(inequality_list)){
  temp_df <- inequality_list[[i]] %>% 
                    pivot_longer(!c('HDI Rank (2018)', 'Country'), 
                                 names_to = "Year", 
                                 values_to = names(inequality_list[i]))
  inequality_df <- inequality_df %>%
                      full_join(temp_df %>% select(-'HDI Rank (2018)'), 
                                by = c('Country','Year'))
}
head(inequality_df)
```

Note that the columns of `inequality_df` are currently all of type `<chr>` when only `Country` should be of type `<chr>`, `Year` should be of type integer, and the remaining be of type numeric.  This is because missing values are given as '..' instead of `NA`.  Convert the relevant columns to numeric which coerces '..' to `NA`'s in the process.  

```{r warning = FALSE}
inequality_df[,4:12] <- as.data.frame(sapply(inequality_df[,4:12], as.numeric))
inequality_df$Year <- as.integer(inequality_df$Year)
head(inequality_df)
```

To complete the data transformation, notice that under `Country`, the last 17 rows of each data frame contain aggregate data regional data, and are not countries: 

```{r}
tail(inequality_list[[1]]$Country,17)
```
Therefore, they will be removed from `inequality_df`.

```{r}
not_countries <- tail(inequality_list[[1]]$Country,17)
 
inequality_df <- inequality_df %>% 
  filter(!(Country %in% not_countries))
```

The head and tail of the tidy data frame is:

```{r}
head(inequality_df)
tail(inequality_df)
inequality_df %>% write_csv('./Inequality/inequality_tidy.csv')
```


## Human Security Data Transformation


Below is the code required to compose and organize the Human Security dataset.

Transforming this data largely required reorganizing the dataframe into a tidy
format.  A great number of data values are missing, discussed below.  Converting
the data from its .csv file into a workable R dataframe required removing 
blank columns (which had been left in the Excel files for visual appeal) and 
renaming columns to prime them for the pivot_longer function.  Further, to 
avoid losing data when merging the Human Security variable datasets (Homeless-
ness from natural disasters, Homicide rate, Prison population, Refugees by 
country of origin, Suicide rate for males, and Suicide rate for females), the 
all.x and all.y conditions were specified.  Then, to ensure that all missing
data were coded appropriately, a for loop was introduced to convert all numeric
data columns in the dataset into numeric type.  The result is a tidy dataset of 
all Human Security variables.



```{r,echo=TRUE}


Homeless.natural.disaster <- read.csv("./HumanSecurity/Homeless.natural.disaster.csv")
Homicide.rate <- read.csv("./HumanSecurity/Homicide.rate.csv")
Prison.popn <- read.csv("./HumanSecurity/Prison.population.csv")
Refugees <- read.csv("./HumanSecurity/Refugees.csv")
Suicide.rate.M <- read.csv("./HumanSecurity/Suicide.rate.M.csv")
Suicide.rate.F <- read.csv("./HumanSecurity/Suicide.rate.F.csv")

names(Homeless.natural.disaster)[2:30] <- c("1990", "1991", "1992", "1993", "1994", "1995", "1996", "1997", "1998", "1999", "2000", "2001", "2002", "2003", "2004", "2005", "2006", "2007", "2008", "2009", "2010", "2011", "2012", "2013", "2014", "2015", "2016", "2017", "2018")
dcol <- 2
for (i in 2:ncol(Homeless.natural.disaster)) {
  Homeless.natural.disaster[,dcol] <- as.numeric(Homeless.natural.disaster[,dcol])
  dcol <- dcol +1
}

Homicide.rate <- subset(Homicide.rate, select = -c(X, X.1, X.2, X.3, X.4, X.5, X.6, X.7, X.8, X.9, X.10))
names(Homicide.rate)[2:13] <- c("1990", "1995", "2000", "2005", "2010", "2011", "2012", "2013", "2014", "2015", "2016", "2017")
dcol <- 2
for (i in 2:ncol(Homicide.rate)) {
  Homicide.rate[,dcol] <- as.numeric(Homicide.rate[,dcol])
  dcol <- dcol +1
}

Prison.popn <- subset(Prison.popn, select = -c(X, X.1, X.2, X.3, X.4, X.5, X.6, X.7, X.8, X.9))
names(Prison.popn)[2:11] <- c("2003", "2005", "2010", "2011", "2012", "2013", "2014", "2015", "2016", "2017")
dcol <- 2
for (i in 2:ncol(Prison.popn)) {
  Prison.popn[,dcol] <- as.numeric(Prison.popn[,dcol])
  dcol <- dcol +1
}

Refugees <- subset(Refugees, select = -c(X, X.1, X.2, X.3, X.4, X.5, X.6, X.7, X.8, X.9))
names(Refugees)[2:11] <- c("2003", "2005", "2010", "2011", "2012", "2013", "2014", "2015", "2016", "2017")
dcol <- 2
for (i in 2:ncol(Refugees)) {
  Refugees[,dcol] <- as.numeric(Refugees[,dcol])
  dcol <- dcol +1
}

Suicide.rate.F <- subset(Suicide.rate.F, select = -c(X, X.1, X.2))
names(Suicide.rate.F)[2:5] <- c("2000", "2010", "2015", "2016")
dcol <- 2
for (i in 2:ncol(Suicide.rate.F)) {
  Suicide.rate.F[,dcol] <- as.numeric(Suicide.rate.F[,dcol])
  dcol <- dcol +1
}

Suicide.rate.M <- subset(Suicide.rate.M, select = -c(X, X.1, X.2))
names(Suicide.rate.M)[2:5] <- c("2000", "2010", "2015", "2016")
dcol <- 2
for (i in 2:ncol(Suicide.rate.M)) {
  Suicide.rate.M[,dcol] <- as.numeric(Suicide.rate.M[,dcol])
  dcol <- dcol +1
}

HND <- pivot_longer(Homeless.natural.disaster, cols = !Country, names_to = "Year", values_to = "Homeless.ND")
HR <- pivot_longer(Homicide.rate, cols = !Country, names_to = "Year", values_to = "Homicide.rate")
PP <- pivot_longer(Prison.popn, cols = !Country, names_to = "Year", values_to = "Prison.popn")
R <- pivot_longer(Refugees, cols = !Country, names_to = "Year", values_to = "Refugees")
SRF <- pivot_longer(Suicide.rate.F, cols = !Country, names_to = "Year", values_to = "Suicide.rate.F")
SRM <- pivot_longer(Suicide.rate.M, cols = !Country, names_to = "Year", values_to = "Suicide.rate.M")
Human.Security <- merge(HND, HR, all.x = T, all.y = T)
Human.Security <- merge(Human.Security, PP, all.x = T, all.y = T)
Human.Security <- merge(Human.Security, R, all.x = T, all.y = T)
Human.Security <- merge(Human.Security, SRF, all.x = T, all.y = T)  
Human.Security <- merge(Human.Security, SRM, all.x = T, all.y = T)
Human.Security <- Human.Security[30:5684,]
```



## Education Data Transformation


In order to read in the education data-- I first take in every file in the relevant Education directory. With this data I determine the relevant NAs in the files, and code those as NAs. Similarly I skip the first line in the file which are blank. Then I remove any rows that are irrelevant-- specifically the rows with footnotes. Finally I remove additional columns, and change data types if necessary, and am then ready to transform the data itself.

```{r,echo=TRUE}

dr="./Education/csv"
file_list <- list.files(path=dr,pattern="*.csv")
dttyp<-c("EdInd","ExpSch","ExpSchF","ExpSchM","GovMon","GERPP","GERP","GERS","GERT",
         "LitR","MYSch","MYSchF","MYSchM","PerPSInt","PerSSInt","PopSSF25U","PopSSM25U",
         "PSDrop","PSTchTrn","PISAMth","PISARead","PISAScn","PupTchRPS","SurvRSGE")

for (i in 1:length(file_list)){
   df_temp<-read.csv(paste(dr,"/",file_list[i],sep=""),skip=1,header=T, 
                      check.names = F,na.strings=c("..",""," ","<NA>"))
   df_temp<-subset(df_temp,!grepl("[a-z]:",df_temp$`HDI Rank (2018)`))
   df_temp$`HDI Rank (2018)`<-as.numeric(df_temp$`HDI Rank (2018)`)
   df_temp$var<-dttyp[i]
   if (i==1) {
     df_ed<-df_temp[!sapply(df_temp, function(x) all(is.na(x)))]}
   else {df_ed<-bind_rows(df_ed,df_temp[!sapply(df_temp, function(x) all(is.na(x)))])}
   
}
df_ed<-df_ed[,!grepl("\\.[0-9]",colnames(df_ed))]
```

Once the files are read in correctly I create two separate forms of the data. One with each variable as a column, and year as its own signular column using pivot longer, and wider, and one where the relevant education vartiables are also in a singular column. While the seconde format is not necessarily tidy this will help look at missings across the data.

```{r,echo=TRUE}
df_ed_lg<-df_ed %>%
            pivot_longer(cols=!c("HDI Rank (2018)","Country","var"),names_to="Year",values_to="HDI") 
df_ed_td<-df_ed_lg %>%
            pivot_wider(names_from="var",values_from="HDI")

df_ed_td %>% write_csv('./Education/Education_Tidy.csv')
df_ed_lg %>% write_csv('./Education/Education_Wide.csv')
```

